namespace :employer_invoice do
  desc "Generates Invoices for Initial and Conversion Employers"
  task generate: :environment do

    DO_NOT_INVOICE_LIST = ["520743373", "530026395", "550825492", "453987501", "530164970", "237256856",
     "611595539", "591640708", "521442741", "521766561", "522167254", "521826441", "530176859", "521991811",
     "522153746", "521967581", "147381250", "520968193", "521143054", "521943790", "520954741", "462199955",
     "205862174", "521343924", "521465311", "521816954", "020614142", "521132764", "521246872", "307607552",
     "522357359", "520978073", "356007147", "522315929", "521989454", "942437024", "133535334", "462612890",
     "541873351", "521145355", "530071995", "521449994"]

    @folder_name="DCEXCHANGE_#{TimeKeeper.date_of_record.strftime("%Y%m%d")}"

    conversion_employers = Organization.where({
      :'employer_profile.profile_source' => 'conversion',
      :'employer_profile.plan_years' => {
        :$elemMatch => {
            :"start_on" => { "$eq" => DateTime.parse("2016-12-01" ) } ,
            :"aasm_state".in =>  PlanYear::RENEWING_PUBLISHED_STATE
          }
        }
    })

    new_employers = Organization.where({
      :'employer_profile.plan_years' => {
       :$elemMatch => {
         :start_on =>  { "$eq" => DateTime.parse("2016-12-01" ) },
         :"aasm_state".in => PlanYear::PUBLISHED
       }}
    })

    renewing = Organization.where({
      :'employer_profile.profile_source'.ne => 'conversion',
      :'employer_profile.plan_years' => {
        :$elemMatch => {
            :"start_on" => { "$eq" => DateTime.parse("2016-12-01" ) } ,
            :"aasm_state".in =>  PlanYear::RENEWING_PUBLISHED_STATE
          }
        }
    })

    generate_invoices(conversion_employers, false)
    # generate_invoices(renewing, false)
    # generate_invoices(new_employers, true)

    #Create a tar file
    puts "creating a tar file now"
    	system("tar -zcvf #{@folder_name}.tar.gz #{@folder_name}")
    puts "Folder created!"

  end

  def generate_invoices(organizations, clean_up = nil )
    organizations.each do |org|
      unless DO_NOT_INVOICE_LIST.include?(org.fein) || !org.employer_profile.plan_years.renewing.first.try(:is_enrollment_valid?)
        if clean_up
          employer_invoice = EmployerInvoice.new(org,@folder_name)
          employer_invoice.save_and_notify_with_clean_up
        else
          employer_invoice = EmployerInvoice.new(org,@folder_name)
          employer_invoice.save_and_notify
        end
      end
    end
  end

  desc "Generates Invoices for Conversion Employers, given FEIN"
  task generate_by_fein: :environment do

    @folder_name="DCEXCHANGE_#{TimeKeeper.date_of_record.strftime("%Y%m%d")}"

    INVOICE_LIST_BY_FEIN = ["274164153", "522053816", "453611858", "264022105", "251913783", "521992631", "522050165",
      "522274900", "521829463", "800373809", "461617074", "521006027", "200453861", "800575600", "264568349", "060636098",
      "205036794", "520741768", "980074719", "412263015", "331150067", "640856843", "263525897", "522015028", "522179070",
      "561914139", "261345012", "134214479", "522006429", "454199880", "521766578", "464308418", "521165975", "530160520",
      "521173590", "521300155", "522275123", "522174340", "273076296", "471911289", "522039470", "204268199", "521202936",
      "522336910", "541379174", "521009973", "526057767", "542165922", "521439709", "133182027", "521953502", "866052376",
      "521236600", "366142798", "131958990", "237225346", "521180441", "522137874", "231722119", "520745115", "521870003",
      "530025360", "530173091", "530196544", "522217136", "130432130", "237291856", "521238026", "133173374", "061634525",
      "520882226", "530259463", "520805605", "520895129", "204079553", "522261594", "132798416", "530242653", "530259019",
      "521065110", "521611820", "742676503", "521464785", "461686004", "521821574", "261704770", "203017960", "274356703",
      "300261138", "562189635", "680499465", "530184431", "521155917", "521244373", "463276663", "521395040", "521270511",
      "522140596", "521614093", "141865840", "522102012", "133619000", "132627568", "366144553", "521314223", "530207414",
      "521072223", "561009730", "416029770", "237104188", "521660112", "520784198", "521926756", "650617866", "237446280",
      "522358563", "270383570", "061420853", "541625869", "541146619", "521810339", "520971440", "520996424", "530179971",
      "521354253", "320225854", "134301450", "541712545", "232713126", "201034580", "830465078", "131985476", "520906130",
      "530257383", "521785122", "521888690", "461738726", "452805033", "043411708", "141888764", "530214244", "520965477",
      "521746886", "542037890", "133119290", "200479580", "205369608", "272267002", "521099908", "521403770", "521547440",
      "453734369", "261914515", "521938660", "136075750", "522082666", "521536666", "272227363", "541814954", "521927957",
      "030390222", "205713721", "273066550", "462386906", "010634325", "061724322", "521681375", "520982839", "520990788",
      "521481239", "521513111", "522012698", "521243510", "521368522", "520969534", "521916489", "142013966", "521271179",
      "264336291", "521335902", "202657674", "161641769", "263456686", "800020219", "113782102", "521887951", "273761788",
      "275140346", "611611943", "980468168", "520993839", "521460020", "237122879", "530228711", "454761753", "200916214",
      "521175377", "200729867", "364620549", "201379510", "541204000", "522084049", "271712788", "522208894", "481150519",
      "813609023", "260681160", "521033340", "452744746", "260763959", "522326356", "521162473", "521401942", "521307706",
      "593735613", "275314539", "202073155", "204394246", "541029990", "510006522", "522141497", "541787099", "522326004",
      "522019014", "260051844", "030561944", "742112921", "521832497", "270248027", "520894477", "205712546", "521956796",
      "521245222", "521690505", "521900312", "200649353", "521243624", "205494704", "521154418", "571152625", "521217891",
      "541512177", "510153566", "526082290", "042693322", "311677573", "521905358", "208247530", "522165893", "311794048",
      "521446207", "521730890", "521275227", "530045180", "521480805", "541657505", "521188012", "521513604", "520970462",
      "131641066", "521343066", "161629886", "521765124", "421772909", "135568722", "521613610", "911433368", "526081813",
      "521559049", "521951694", "202549092", "522165072", "522155986", "521750323", "203513619", "261910540", "260413629",
      "522054389", "331112770", "271759863", "521743592", "521782459", "900849826", "521231278", "830398572", "522006843",
      "721581607", "201040587", "223887397", "043593202", "956377796", "521160561", "521686163", "161764228", "521862113",
      "521774773", "430164315", "520880625", "530175639", "453575852", "300101425", "453090057", "521247182", "274701474",
      "521296972", "391211513", "261789967", "522148126", "521224809", "383777896", "530190293", "465249281", "371731850",
      "521064944", "522330981", "260269860", "521106749", "521676581", "521536215", "237209274", "530113987", "272623232",
      "520847160", "261111775", "541250228", "522116063", "521906632", "262918853", "200416717", "521915952", "522226023",
      "410659918", "205498427", "260007250", "462214574", "264808983", "201438857", "201055716", "300239760", "262293471",
      "260004013", "453244028", "521723912", "541122182", "522177263", "272951650", "530056498", "521155223", "020767621",
      "521827718", "522342182", "521371692", "521543502", "521840230", "261446183", "530115490", "521002561", "521277588",
      "521233445", "521223816", "521501084", "521679409", "200141519", "521837044", "521638461", "541489044", "521194473",
      "530231308", "520904941", "521073544", "521154866", "521212543", "205198758", "521557765", "341911960", "203895611",
      "522066196", "453968279", "520913781", "000000072", "000000066", "000000081", "000000082", "000000067", "000000068",
      "201419095", "521757065", "521504315", "530196970", "522266800", "522102208", "980395850", "133798288", "954789334",
      "521360067", "223948762", "522222888", "030415607", "134211951", "521653484", "271263534", "520855005", "521801566",
      "820578781", "521960228", "521561592", "521665058", "450470521", "453645860", "980433296", "208455586", "521134631",
      "526054231", "060662124", "030372927", "521268030", "521654284", "743078079", "261616418", "530241716", "522416421",
      "522330646", "454102644", "521056551", "520957293", "522168852", "521062824", "270824391", "204820253", "264279830",
      "461020356", "208924675", "530217160", "521071816", "462697170", "450707471", "743091832", "200285909", "010632142",
      "455061766", "541966352", "526046206", "521495514", "541576989", "363235550", "136226549", "743092027", "521785734",
      "521643439", "521706059", "521318405", "200587793", "521188465", "263513048", "262989554", "591117574", "521331738",
      "208031777", "364496931", "222635292", "331110749", "521017612", "521179642", "521002895", "522283691", "522193344",
      "043462709", "520894961", "263639601", "237420660", "300220874", "521257712", "464655147", "753029336", "300262973",
      "521354047", "562497096", "521488921", "522022644", "521846579", "522149174", "450993413", "522170399", "263386082",
      "522302911", "521102259", "203625449", "521218074", "521346704", "208587628", "522252820", "521571905", "521452751",
      "521125907", "520889266", "522349433", "520816071", "521387292", "460485203", "412143316", "455620445", "510845091",
      "561356764", "521160286", "521021004", "331130181", "521539377", "521734147", "530234585", "270201126", "452262685",
      "270676092", "520884670", "521194012", "202132625", "541144392", "202257507", "562619291", "521876668", "454919286",
      "261371357", "521007180", "263678976", "364754188", "363668803", "042694458", "263917527", "256036844", "521264536",
      "271071179", "562176961", "460476632", "880437088", "521368226", "870798193", "455282628", "611448946", "271476998",
      "521755403", "260509118", "592219888", "520939288", "530233965", "521628405", "520850356", "462399460", "521166432",
      "010764853", "521227880", "521312425", "510393615", "530260404", "043670163", "208003146", "760149778", "521265221",
      "521038313", "521709212", "061111760", "272151493", "521867428", "521645397", "521737540", "542021613", "364661603",
      "522082388", "521994310", "522132330", "454157966", "521245936", "511772195", "521807655", "521764945", "273670371",
      "521399520", "521549572", "130870910", "311205596", "061328907", "521696342", "522330220", "271026083", "261643365",
      "521830369", "320302875", "331171558", "541949996", "237416302", "300116135", "521570071", "203076690", "520887806",
      "521497461", "521131788", "530207484", "136130873", "510392124", "942578166", "460540994", "300664947", "270208831",
      "743099965", "561123657", "208185555", "521603888", "521500760", "521987523", "520746482", "202635201", "132658474",
      "132809895", "521039544", "521682263", "521451790", "201528791", "521407861", "521065441", "200373574", "521074743",
      "237268143", "521733421", "200102713", "521130140", "522197491", "953132674", "521970954", "520795113", "161680323",
      "205990197", "320246016", "521911066", "020666404", "462351134", "521253392", "274278956", "521880136", "251907521",
      "521730454", "522057215", "521233065", "263416792", "536000291", "237262876", "521002207", "521739514", "542026609",
      "521038604", "208478079", "521551867", "521337494", "522026617", "270004331", "521552960", "521534412", "521972855",
      "521802021", "521763385", "522076894", "522069850", "260003950", "521153181", "521933344", "271832870", "201416996",
      "710954651", "521766131", "911821040", "521811881", "363304707", "522113631", "521784961", "275121527", "412077048",
      "521202860", "942914158", "680661580", "521760825", "521139820", "521816960", "113803659", "522001796", "522068483",
      "260631725", "461490967", "753098460", "453306993", "521300027", "742558174", "541901882", "030377568", "522302253",
      "522332695", "522164356", "530259113", "521969794", "521291656", "521260698", "521299197", "521231772", "541677984",
      "522052220", "521670976", "522111567", "522064776", "522169916", "520799424", "274565900", "205888246", "530185575",
      "263423690", "521954140", "521866253", "522011636", "541811642", "200492252", "522338963", "760514428", "522206000",
      "521547224", "521142930", "521297358", "521010336", "521851481", "521230205", "204411492", "521306451", "541287652",
      "521331552", "521668934", "132901181", "134339046", "522123640", "521958229", "201854987", "274364274", "521197565",
      "521588092", "521410035", "521263256", "521007373", "741916260", "530259954", "521238058", "711017781", "222096315",
      "273586050", "520845105", "412090291", "522065422", "562231621", "521191519", "311669930", "310729205", "521364763",
      "264343046", "203532641", "760832248", "383653116", "541557043", "300274709", "530204609", "520983141", "237329291",
      "840617736", "521260579", "521318222", "237417702", "221661978", "510141374", "480668648", "363015603", "480793589",
      "520908178", "521147591", "522055016", "300022798", "540579473", "530196619", "521312579", "522016840", "361521980",
      "520698385", "530210846", "521047451", "742291620", "530238079", "521884446", "521477599", "521339888", "521834892",
      "237226316", "020620456", "521624852", "521633883", "521382926", "237304915", "521916480", "521578289", "237094479",
      "237124915", "530216598", "731006395", "222127884", "300075580", "530224364", "521482678", "530116540", "521081261",
      "530196627", "431990991", "611684645", "521080991", "942607722", "260488308", "521636004", "271432208", "237158016",
      "361486340", "522212275", "522035844", "521112174", "522037541", "530119620", "522289435", "273180147", "522007891",
      "205242161", "520806301", "521829602", "530246919", "454848546", "521306301", "530197079", "203272355", "270038119",
      "273153531", "522237798", "453806445", "231523015", "521636891", "361589720", "261118726", "521999959", "521618612",
      "222443279", "941347046", "530259342", "273351024", "200003637", "111709989", "521731636", "521757990", "452636954",
      "954229963", "521590800", "200014151", "261113579", "205409441", "521335949", "521658883", "270808021", "450931286",
      "522070615", "522199591", "260525296", "521059121", "200342487", "530197039", "262593428", "900739565", "521381941",
      "331125059", "521923733", "521846004", "521153323", "050602702", "464365172", "521101422", "043586873", "363496559",
      "530214030", "520909311", "204064059", "270772753", "522179499", "521645566", "522239365", "521902336", "541473144",
      "522050398", "530234512", "521078400", "522217817", "200031713", "274509053", "364192410", "020564317", "260551523",
      "131790733", "521720618", "536001766", "521909854", "900639569", "550845810", "520748761", "541638699", "470943973",
      "274256450", "521046861", "271044110", "521452178", "521886511", "521907673", "521735240", "472301994", "522330214",
      "521386172", "450556540", "273250400", "541949211", "521994743", "611450728", "900833212", "530182962", "522328017",
      "208280629", "270690349", "452677300", "522100414", "521585880", "562313389", "371635326", "521516482", "522438802",
      "270221124", "521203707", "521099692", "521841035", "522000279", "521469643", "522095359", "203690821", "541861234",
      "454862460", "132522784", "521186689", "521173127", "521804690", "272974607", "541770201", "520936436", "270463190",
      "521132262", "454149985", "520817609", "752454806", "043382840", "141937022", "520969706", "521970927", "520797884",
      "030375454", "132903885", "541478345", "237380554", "113769103", "136188433", "205639114", "000000070", "263198607",
      "522114707", "521434143", "521951094", "522093357", "521221798", "222935308", "542061534", "521431093", "521333416",
      "201727977", "371503446", "272896127", "521153898", "521985664", "521595586", "371436999", "521277041", "520950979",
      "521544284", "521377722", "520859021", "522113471", "521794095", "020720288", "461373125", "222238037", "262596125",
      "521072179", "522045614", "521161473", "521113253", "541880332", "205393038", "522044271", "521695387", "412114484",
      "521098016", "521659884", "521882549", "331102420", "520807552", "274806540", "201297050", "521111670", "461459245",
      "203903427", "530152875", "237420574", "371447724", "541297878", "800100799", "522206780", "271716438", "522144360",
      "521441586", "260686407", "131952497", "131820189", "521256181", "571172238", "521472546", "462904135", "133466462",
      "522149736", "371489712", "841693731", "521703065", "311778598", "561267540", "522065771", "273567814", "205835776",
      "530231513", "262304417", "520847434", "522313694", "980475219", "204343537", "264727240", "463351495", "273235008",
      "520895826", "261287688", "521168592", "203674456", "521732629", "521832275", "300548743", "942478143", "272011283",
      "521297949", "522010868", "521275264", "521736536", "522242472", "521760910", "870716009", "530162570", "522285516",
      "261650447", "521818907", "521699641", "521922209", "521260292", "521250974", "521170680", "521036671", "260289817",
      "521084768", "526036989", "521974611", "952856725", "204145524", "201194104", "611480714", "651266817", "621350585",
      "530121275", "141952056", "521128863", "521816236", "980666115", "520941402", "061701395", "521744394", "331001509",
      "521880607", "208049850", "820583504", "521443146", "270683070", "522031849", "521617092", "204587059", "522314001",
      "270359097", "043706385", "201734070", "316032844", "521294328", "521785229", "271329984", "521827235", "133576444",
      "521311513", "520816920", "521985316", "453695924", "201597444", "522257066", "526070337", "521758423", "382495938",
      "521104476", "042790740", "462216565", "363071241", "521797549", "222701978", "112494808", "521280412", "530159345",
      "541424487", "522156691", "520902922", "520816670", "208049576", "542009184", "521161897", "030506737", "800326026",
      "453538747", "521675037", "454518964", "461801360", "260859181", "540969656", "522318387", "237161537", "521149668",
      "201605555", "261178742", "530190551", "521953143", "530261104", "522106206", "522276849", "522335037", "621148609",
      "521706976", "800424607", "521543944", "522230852", "311795776", "203102777", "237305477", "521107948", "208701633",
      "300384648", "522148467", "010924743", "521713143", "810554556", "521677432", "521545522", "521071570", "521325467",
      "352168568", "520810472", "521974695", "521756853", "520983925", "453174572", "452625518", "521953385", "522143504",
      "980578659", "520970458", "521779483", "453458519", "270276145", "201572068", "463378865", "202029170", "521046243",
      "371571283", "200955851", "522203967", "520897624", "521539890", "521798732", "521997225", "530169720", "522023392",
      "521818839", "383727585", "530245460", "474596450", "521242900", "541715875", "262852431", "237367468", "204668214",
      "520999491", "231823874", "522275554", "223862039", "530208365", "812741295", "131624103", "521235307", "530245853",
      "382346425", "522102391", "541836356", "521540128", "271843322", "522303820", "860944034", "451292936"]

    organizations = Organization.where(:"fein".in => INVOICE_LIST_BY_FEIN)
    organizations.each do |org|
      employer_invoice = EmployerInvoice.new(org,@folder_name)
      employer_invoice.save_and_notify
    end
    puts "creating a tar file now"
      system("tar -zcvf #{@folder_name}.tar.gz #{@folder_name}")
    puts "Folder created!"
  end
end
